<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>MDT Map</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
<link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />
<style>
body { margin: 0; padding: 0; }
#map { position: absolute; top: 0; bottom: 0; width: 100%; }
.marker {
  background-size: cover;
  width: 32px;
  height: 32px;
  border-radius: 50%;
}
</style>
</head>
<body>
<div id="map"></div>

<script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
<script>
// Init Map
const map = new maplibregl.Map({
  container: 'map',
  style: 'https://basemaps.cartocdn.com/gl/positron-gl-style/style.json',
  center: [-71.06, 42.36],
  zoom: 12
});

// Get URL Params
const urlParams = new URLSearchParams(window.location.search);
const callsParam = urlParams.get('calls');
const unitsParam = urlParams.get('units');

let activeCalls = [];
let units = [];

try {
  if (callsParam) activeCalls = JSON.parse(atob(callsParam));
  if (unitsParam) units = JSON.parse(atob(unitsParam));
} catch (e) {
  console.error("Error parsing params", e);
}

console.log("Active Calls", activeCalls);
console.log("Units", units);

// Add Marker
function addMarker(lng, lat, icon, title) {
  const el = document.createElement('div');
  el.className = 'marker';
  el.style.backgroundImage = `url(${icon})`;

  new maplibregl.Marker(el)
    .setLngLat([lng, lat])
    .setPopup(new maplibregl.Popup().setHTML(`<b>${title}</b>`))
    .addTo(map);
}

// Add Calls Markers
activeCalls.forEach(call => {
  addMarker(call.lng, call.lat, "https://upload.wikimedia.org/wikipedia/commons/6/6c/Phone_icon.png", call.title);
});

// Add Units Markers
units.forEach(unit => {
  const title = unit.title || `${unit.unit_id} - ${unit.status}`;
  addMarker(unit.lng, unit.lat, "https://upload.wikimedia.org/wikipedia/commons/8/89/Ambulance_icon.png", title);
});
</script>

</body>
</html>
